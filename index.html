<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор коммунальных платежей</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Калькулятор коммунальных платежей</h1>
        
        <div class="mb-4">
            <label for="month" class="mr-2">Месяц:</label>
            <select id="month" class="border rounded p-1">
                <option value="0">Январь</option>
                <option value="1">Февраль</option>
                <option value="2">Март</option>
                <option value="3">Апрель</option>
                <option value="4">Май</option>
                <option value="5">Июнь</option>
                <option value="6">Июль</option>
                <option value="7">Август</option>
                <option value="8">Сентябрь</option>
                <option value="9">Октябрь</option>
                <option value="10">Ноябрь</option>
                <option value="11">Декабрь</option>
            </select>
            <label for="year" class="ml-4 mr-2">Год:</label>
            <input type="number" id="year" class="border rounded p-1" value="2024">
        </div>

        <table class="w-full bg-white shadow-md rounded mb-4">
            <thead>
                <tr class="bg-gray-200">
                    <th class="p-2">Услуга</th>
                    <th class="p-2">Тариф</th>
                    <th class="p-2">Предыдущие показания</th>
                    <th class="p-2">Текущие показания</th>
                    <th class="p-2">Расход</th>
                    <th class="p-2">Сумма</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="p-2">Горячая вода</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full previous"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full current"></td>
                    <td class="p-2"><span class="usage"></span></td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Горячая вода водоотведения</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full previous"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full current"></td>
                    <td class="p-2"><span class="usage"></span></td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Газ</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full previous"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full current"></td>
                    <td class="p-2"><span class="usage"></span></td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Холодная вода</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full previous"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full current"></td>
                    <td class="p-2"><span class="usage"></span></td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Электроэнергия</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full previous"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full current"></td>
                    <td class="p-2"><span class="usage"></span></td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Вывоз мусора</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Отопление (абонентский платеж)</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Холодная вода (абонентский платеж)</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Газ (доставка)</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Квартплата</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Горячая вода (абонентское обслуживание)</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Отопление</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full previous"></td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full current"></td>
                    <td class="p-2"><span class="usage"></span></td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
                <tr>
                    <td class="p-2">Домофон</td>
                    <td class="p-2"><input type="number" step="0.01" class="border rounded p-1 w-full rate"></td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2">-</td>
                    <td class="p-2"><span class="total"></span></td>
                </tr>
            </tbody>
        </table>

        <p class="text-xl font-bold mb-4">Итого: <span id="total">0</span> руб.</p>

        <div class="flex space-x-2 mb-4">
            <button onclick="saveData()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Сохранить данные
            </button>
            <button onclick="clearData()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                Очистить данные
            </button>
            <button onclick="exportToCSV()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                Экспорт в CSV
            </button>
            <input type="file" id="importCSV" accept=".csv" class="hidden">
            <button onclick="document.getElementById('importCSV').click()" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                Импорт из CSV
            </button>
        </div>

        <div class="mb-4">
            <canvas id="expensesChart"></canvas>
        </div>
    </div>

    <script>
        let currentData = {};

        function calculate() {
            let total = 0;
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rate = parseFloat(row.querySelector('.rate').value) || 0;
                const previous = parseFloat(row.querySelector('.previous')?.value) || 0;
                const current = parseFloat(row.querySelector('.current')?.value) || 0;
                const usage = current - previous;
                const rowTotal = rate * (usage || 1);  // Если нет usage, умножаем на 1 (для фиксированных платежей)

                if (!isNaN(usage)) {
                    row.querySelector('.usage').textContent = usage.toFixed(2);
                }
                row.querySelector('.total').textContent = rowTotal.toFixed(2);
                total += rowTotal;
            });
            
            document.getElementById('total').textContent = total.toFixed(2);
            updateChart();
        }

        function saveData() {
            const month = document.getElementById('month').value;
            const year = document.getElementById('year').value;
            const key = `utilityBillData_${year}_${month}`;
            
            const rows = document.querySelectorAll('tbody tr');
            currentData = {};
            rows.forEach(row => {
                const service = row.querySelector('td').textContent;
                currentData[service] = {
                    rate: row.querySelector('.rate').value,
                    previous: row.querySelector('.previous')?.value || '',
                    current: row.querySelector('.current')?.value || ''
                };
            });

            localStorage.setItem(key, JSON.stringify(currentData));
            alert('Данные сохранены');
        }

        function loadData() {
            const month = document.getElementById('month').value;
            const year = document.getElementById('year').value;
            const key = `utilityBillData_${year}_${month}`;
            
            const data = JSON.parse(localStorage.getItem(key));
            if (data) {
                currentData = data;
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const service = row.querySelector('td').textContent;
                    if (currentData[service]) {
                        row.querySelector('.rate').value = currentData[service].rate;
                        if (row.querySelector('.previous')) row.querySelector('.previous').value = currentData[service].previous;
                        if (row.querySelector('.current')) row.querySelector('.current').value = currentData[service].current;
                    }
                });
                calculate();
            } else {
                clearData();
            }
        }

        function clearData() {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                row.querySelectorAll('input').forEach(input => input.value = '');
                row.querySelector('.usage').textContent = '';
                row.querySelector('.total').textContent = '';
            });
            document.getElementById('total').textContent = '0';
            currentData = {};
            updateChart();
        }
        
        function exportToCSV() {
            const rows = document.querySelectorAll('tbody tr');
            let csv = 'Услуга,Тариф,Предыдущие показания,Текущие показания,Расход,Сумма\n';
            rows.forEach(row => {
                const service = row.querySelector('td').textContent;
                const rate = row.querySelector('.rate').value;
                const previous = row.querySelector('.previous')?.value || '';
                const current = row.querySelector('.current')?.value || '';
                const usage = row.querySelector('.usage').textContent;
                const total = row.querySelector('.total').textContent;
                csv += `${service},${rate},${previous},${current},${usage},${total}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `utility_bill_${document.getElementById('year').value}_${document.getElementById('month').value}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                // Пропускаем заголовок
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    const values = lines[i].split(',');
                    const rows = document.querySelectorAll('tbody tr');
                    for (const row of rows) {
                        if (row.querySelector('td').textContent === values[0]) {
                            row.querySelector('.rate').value = values[1];
                            if (row.querySelector('.previous')) row.querySelector('.previous').value = values[2];
                            if (row.querySelector('.current')) row.querySelector('.current').value = values[3];
                            break;
                        }
                    }
                }
                calculate();
            };
            reader.readAsText(file);
        }

        function updateChart() {
            const ctx = document.getElementById('expensesChart').getContext('2d');
            const labels = [];
            const data = [];
            
            document.querySelectorAll('tbody tr').forEach(row => {
                labels.push(row.querySelector('td').textContent);
                data.push(parseFloat(row.querySelector('.total').textContent));
            });

            // Уничтожаем предыдущий график, если он существует
            if (window.myChart instanceof Chart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Расходы',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        document.getElementById('month').addEventListener('change', loadData);
        document.getElementById('year').addEventListener('change', loadData);
        document.getElementById('importCSV').addEventListener('change', importFromCSV);
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', calculate);
        });

        window.addEventListener('load', () => {
            const currentDate = new Date();
            document.getElementById('month').value = currentDate.getMonth();
            document.getElementById('year').value = currentDate.getFullYear();
            loadData();
        });
    </script>
</body>
</html>
